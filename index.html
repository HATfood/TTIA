<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>Ø§Ù†Ø¬Ù…Ù† ØµÙ†Ø§ÛŒØ¹ Ú†Ø§ÛŒ ØªÙ‡Ø±Ø§Ù†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- manifest Ø¨Ø±Ø§ÛŒ iOS/Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ -->
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#0f5132">

  <!-- Ø§Ø³Ú©Ø±ÛŒÙ¾Øª OneSignal v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "a1ca9082-d833-4630-972e-e83578a1ef79", // ğŸ‘ˆ App ID Ø®ÙˆØ¯Øª
      });

      // Ø¨Ø±Ú†Ø³Ø¨ (Tag) Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¬Ù„Ø³Ù‡
      OneSignal.User.addTags({ event: "agm-1404-07-05" });

      // Ø´Ù†Ø§Ø³Ù‡â€ŒÛŒ ÛŒÚ©ØªØ§ (Ø¨Ø±Ø§ÛŒ ØªØ³Øª ÛŒØ§ Ú©Ø§Ø±Ø¨Ø± Ø®Ø§Øµ)
      // OneSignal.login("user_majid_rahmani");
    });
  </script>
</head>
<body>
  <h1>Ø¨Ù‡ Ø§Ù†Ø¬Ù…Ù† ØµÙ†Ø§ÛŒØ¹ Ú†Ø§ÛŒ ØªÙ‡Ø±Ø§Ù† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h1>
  <p>Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ø¬Ù„Ø³Ù‡ØŒ Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø¨Ø²Ù†ÛŒØ¯:</p>

  <!-- Ø¯Ú©Ù…Ù‡ ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ Ù¾ÙˆØ´ -->
  <button id="enable-push">ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</button>

  <script>
    const btn = document.getElementById('enable-push');
    btn.addEventListener('click', async () => {
      try {
        const res = await OneSignal.Notifications.requestPermission();
        if (res === 'granted') {
          alert("Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§ ÙØ¹Ø§Ù„ Ø´Ø¯ âœ…");
        } else {
          alert("Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø§Ø¹Ù„Ø§Ù† Ù†Ø¯Ø§Ø¯ÛŒØ¯ âŒ");
        }
      } catch (e) {
        console.error("Push request error:", e);
      }
    });
  </script>

  <div id="diag" style="font-family: sans-serif; border:1px solid #ddd; padding:12px; margin:16px 0">
  <b>Push Diagnostics</b>
  <div id="d1">Loadingâ€¦</div>
  <div id="d2"></div>
  <div id="d3"></div>
  <div id="d4"></div>
  <div id="d5"></div>
  <button id="req" style="margin-top:8px">ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§</button>
</div>

<script>
  (async () => {
    // Ù„Ø§Ú¯ Ù…ÙØµÙ„
    if (OneSignal?.Debug?.setLogLevel) OneSignal.Debug.setLogLevel('trace');

    const d1 = document.getElementById('d1');
    const d2 = document.getElementById('d2');
    const d3 = document.getElementById('d3');
    const d4 = document.getElementById('d4');
    const d5 = document.getElementById('d5');

    // 0) Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ ÙØ§ÛŒÙ„ SW Ø§Ø² Ø±ÛŒØ´Ù‡
    try {
      const w = await fetch('/OneSignalSDKWorker.js', { cache: 'no-store' });
      d1.textContent = `Worker: HTTP ${w.status} @ /OneSignalSDKWorker.js`;
    } catch (e) {
      d1.textContent = 'Worker fetch error';
    }

    // 1) Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù¾ÙˆØ´
    const supported = await OneSignal.Notifications.isPushSupported();
    d2.textContent = `isPushSupported: ${supported}`;

    // 2) ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ù…ÛŒØ´Ù†
    const status = await OneSignal.Notifications.getPermissionStatus();
    d3.textContent = `permissionStatus: ${status} (expected: 'default' or 'granted')`;

    // 3) Subscription ID
    const subId = await OneSignal.User.PushSubscription.getId();
    d4.textContent = `subscriptionId: ${subId || 'â€”'}`;

    // 4) Ø«Ø¨Øª SW Ø±ÙˆÛŒ Ù‡Ù…ÛŒÙ† Ø§ÙˆØ±ÛŒØ¬ÛŒÙ†ØŸ
    if ('serviceWorker' in navigator) {
      const regs = await navigator.serviceWorker.getRegistrations();
      const hasOS = regs.some(r =>
        (r.active && r.active.scriptURL.includes('OneSignalSDK')) ||
        (r.scriptURL && r.scriptURL.includes('OneSignalSDK'))
      );
      d5.textContent = `SW registered: ${hasOS} (registrations: ${regs.length})`;
    } else {
      d5.textContent = 'serviceWorker: not supported';
    }

    // Ø¯Ú©Ù…Ù‡â€ŒÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø¬Ø§Ø²Ù‡
    document.getElementById('req').onclick = async () => {
      try {
        // Ø§Ú¯Ø± iOS Ù‡Ø³Øª Ùˆ Ø§Ø² Ø¢ÛŒÚ©Ù† Home Ø§Ø¬Ø±Ø§ Ù†Ø´Ø¯Ù‡ØŒ Ù‡Ù…ÛŒÙ†â€ŒØ¬Ø§ Ø®Ø§Ø±Ø¬ Ø´Ùˆ
        // (iOS ÙˆÙ‚ØªÛŒ Ø¯Ø§Ø®Ù„ Safari ØªØ¨ Ù‡Ø³ØªÛŒ Push Ù†Ù…ÛŒâ€ŒØ¯Ù‡)
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        if (isIOS && (window.matchMedia('(display-mode: browser)').matches)) {
          alert('Ø±ÙˆÛŒ iOS Ø¨Ø§ÛŒØ¯ Ø³Ø§ÛŒØª Ø±Ø§ Add to Home Screen Ú©Ù†ÛŒ Ùˆ Ø§Ø² Ø¢ÛŒÚ©Ù† Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒ ØªØ§ Ù¾Ø±Ø§Ù…Ù¾Øª Ø¨ÛŒØ§ÛŒØ¯.');
          return;
        }

        const sup = await OneSignal.Notifications.isPushSupported();
        if (!sup) {
          alert('Push Ø¯Ø± Ø§ÛŒÙ† Ù…Ø­ÛŒØ· Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯ (ÛŒØ§ iOS Ø¯Ø± Ø­Ø§Ù„Øª ØªØ¨ Ø§Ø³Øª).');
          return;
        }

        // Ø±ÙˆØ´ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ÛŒ Ø¯Ø± v16: Slidedown
        if (OneSignal.Slidedown?.promptPush) {
          await OneSignal.Slidedown.promptPush();
        } else {
          // Ø±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ…
          const res = await OneSignal.Notifications.requestPermission();
          alert('permission: ' + res);
        }

        // Ù†Ù…Ø§ÛŒØ´ subId Ø¨Ø¹Ø¯ Ø§Ø² opt-in
        const id = await OneSignal.User.PushSubscription.getId();
        console.log('New subscriptionId:', id);
        d4.textContent = `subscriptionId: ${id || 'â€”'}`;
      } catch (e) {
        console.error(e);
        alert('Error requesting permission (check console)');
      }
    };
  })();
</script>

</body>
</html>
