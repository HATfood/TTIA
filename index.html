<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTIA.ir Push Notifications</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="style.css">

    <!-- OneSignal SDK -->
    <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
    <script>
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      OneSignalDeferred.push(async function(OneSignal) {
        
        await OneSignal.init({
          appId: "a1ca9082-d833-4630-972e-e83578a1ef79",
          autoResubscribe: true,
          
          // === THIS IS THE KEY CHANGE ===
          // We are explicitly telling OneSignal to prepare the slidedown prompt,
          // but NOT to show it automatically. This makes our button click more reliable.
          promptOptions: {
              slidedown: {
                  enabled: true,    // We want to use the slidedown prompt
                  autoPrompt: false // But we DON'T want it to show automatically
              }
          },
        });
        
        updateUI(); 
      });

      async function updateUI() {
          const permission = await OneSignal.getNotificationPermission();
          const isSubscribed = await OneSignal.isPushNotificationsEnabled();
          
          const statusDiv = document.getElementById('status');
          const subscribeButton = document.getElementById('subscribe-button');
          const unsubscribeButton = document.getElementById('unsubscribe-button');
          
          // Disable the button until we know the status to prevent errors
          subscribeButton.disabled = true;

          if (permission === 'denied') {
              statusDiv.textContent = "You have blocked notifications. Please enable them in your browser settings.";
              subscribeButton.style.display = 'none';
              unsubscribeButton.style.display = 'none';
          } else if (isSubscribed) {
              statusDiv.textContent = "You are subscribed to notifications!";
              subscribeButton.style.display = 'none';
              unsubscribeButton.style.display = 'inline-block';
          } else {
              statusDiv.textContent = "Click the button to subscribe.";
              subscribeButton.style.display = 'inline-block';
              unsubscribeButton.style.display = 'none';
              subscribeButton.disabled = false; // Re-enable the button
          }
      }

      async function onSubscribeButtonClick() {
          // This will now reliably show the slidedown prompt we configured above.
          await OneSignal.showSlidedownPrompt();
          updateUI();
      }
      
      async function onUnsubscribeButtonClick() {
          await OneSignal.setSubscription(false);
          updateUI();
      }

    </script>
</head>
<body>

    <div class="container">
        <h1>Welcome to TTIAf .ir</h1>
        <p>Get the latest updates delivered right to your screen.</p>

        <div id="ios-instructions">
            <strong>For iPhone/iPad Users:</strong> To enable notifications, you must first add this site to your Home Screen. Tap the 'Share' icon and then 'Add to Home Screen'.
        </div>

        <div class="button-container">
            <button id="subscribe-button" onclick="onSubscribeButtonClick()" disabled>Loading...</button>
            <button id="unsubscribe-button" onclick="onUnsubscribeButtonClick()" style="display: none;">Unsubscribe</button>
        </div>

        <p id="status">Loading status...</p>
    </div>

</body>
</html>
