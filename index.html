<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8" />
  <title>انجمن صنایع چای تهران</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- مسیر نسبی تا مانیفست (نه /manifest.json) -->
  <link rel="manifest" href="manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="theme-color" content="#0f5132" />

  <!-- OneSignal v16 -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    // کشف base path برای GitHub Pages پروژه‌ای (مثل /my-site/)
    // این کار باعث می‌شود Service Worker در همان scope سایت ثبت شود.
    function getBasePath() {
      // مثال: /my-site/index.html → '/my-site/'
      const path = location.pathname;
      if (path.endsWith(".html")) return path.substring(0, path.lastIndexOf("/") + 1);
      return path.endsWith("/") ? path : path + "/";
    }
    const BASE = getBasePath(); // مثل '/my-site/' یا '/' در دامنهٔ ریشه

    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function (OneSignal) {
      await OneSignal.init({
        appId: "a1ca9082-d833-4630-972e-e83578a1ef79",
        // خیلی مهم: مسیر سرویس‌ورکر نسبی به base
        serviceWorkerPath: BASE + "OneSignalSDKWorker.js",
      });

      // تگ جلسه (دلخواه)
      OneSignal.User.addTags({ event: "agm-1404-07-05" });
      // برای تست ارسال به خودت:
      // OneSignal.login("user_majid_rahmani");
    });
  </script>
</head>
<body>
  <h1>به انجمن صنایع چای تهران خوش آمدید</h1>
  <p>برای دریافت اعلان‌های جلسه، روی دکمه زیر بزنید:</p>

  <button id="enable-push">فعالسازی اعلان‌ها</button>

  <div id="diag" style="font-family:sans-serif;border:1px solid #ddd;padding:12px;margin:16px 0">
    <b>Push Diagnostics</b>
    <div id="d1">Loading…</div>
    <div id="d2"></div>
    <div id="d3"></div>
    <div id="d4"></div>
    <div id="d5"></div>
    <button id="req" style="margin-top:8px">درخواست اجازه اعلان‌ها</button>
  </div>

  <script>
    const btn = document.getElementById("enable-push");
    btn.addEventListener("click", async () => {
      try {
        const res = await OneSignal.Notifications.requestPermission();
        alert(res === "granted" ? "اعلان‌ها فعال شد ✅" : "شما اجازه اعلان ندادید ❌");
      } catch (e) { console.error(e); }
    });

    (async () => {
      if (OneSignal?.Debug?.setLogLevel) OneSignal.Debug.setLogLevel("trace");

      const d1 = document.getElementById("d1");
      const d2 = document.getElementById("d2");
      const d3 = document.getElementById("d3");
      const d4 = document.getElementById("d4");
      const d5 = document.getElementById("d5");

      // فایل SW را با مسیر نسبی چک کن
      try {
        const w = await fetch(BASE + "OneSignalSDKWorker.js", { cache: "no-store" });
        d1.textContent = `Worker: HTTP ${w.status} @ ${BASE}OneSignalSDKWorker.js`;
      } catch { d1.textContent = "Worker fetch error"; }

      const supported = await OneSignal.Notifications.isPushSupported();
      d2.textContent = `isPushSupported: ${supported}`;

      const status = await OneSignal.Notifications.getPermissionStatus();
      d3.textContent = `permissionStatus: ${status}`;

      const subId = await OneSignal.User.PushSubscription.getId();
      d4.textContent = `subscriptionId: ${subId || "—"}`;

      if ("serviceWorker" in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        const hasOS = regs.some(r =>
          (r.active && r.active.scriptURL.includes("OneSignalSDK")) ||
          (r.scriptURL && r.scriptURL.includes("OneSignalSDK"))
        );
        d5.textContent = `SW registered: ${hasOS} (registrations: ${regs.length})`;
      } else {
        d5.textContent = "serviceWorker: not supported";
      }

      document.getElementById("req").onclick = async () => {
        try {
          // iOS: باید Add to Home Screen شود
          const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          if (isIOS && (window.matchMedia("(display-mode: browser)").matches)) {
            alert("روی iOS باید Add to Home Screen کنید و از آیکن اجرا کنید.");
            return;
          }
          const sup = await OneSignal.Notifications.isPushSupported();
          if (!sup) { alert("Push در این محیط پشتیبانی نمی‌شود."); return; }

          if (OneSignal.Slidedown?.promptPush) await OneSignal.Slidedown.promptPush();
          else {
            const res = await OneSignal.Notifications.requestPermission();
            alert("permission: " + res);
          }

          const id = await OneSignal.User.PushSubscription.getId();
          d4.textContent = `subscriptionId: ${id || "—"}`;
        } catch (e) { console.error(e); alert("Error requesting permission"); }
      };
    })();
  </script>
</body>
</html>
